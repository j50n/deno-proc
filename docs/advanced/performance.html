<!DOCTYPE HTML>
<html lang="en" class="navy sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Performance Characteristics - proc</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Run child processes and work with async iterables in Deno—with the fluent Array API you already know.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "navy";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('navy')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">proc</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/j50n/deno-proc" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="performance-characteristics"><a class="header" href="#performance-characteristics">Performance Characteristics</a></h1>
<p>Understanding async iteration performance and how proc optimizes for real-world usage.</p>
<h2 id="the-async-iteration-overhead"><a class="header" href="#the-async-iteration-overhead">The Async Iteration Overhead</a></h2>
<p>Async generators create promises per iteration, which adds overhead for simple operations. <strong>This is built into the JavaScript language and V8 engine</strong>, not a limitation of this library:</p>
<pre><code class="language-typescript">// Benchmark: 10,000 items
async function* double(items: AsyncIterable&lt;number&gt;) {
  for await (const item of items) {
    yield item * 2;
  }
}

// Results:
// Async generator: 2.7ms
// TransformStream: 40µs (67x faster)
// Raw array iteration: 39µs
</code></pre>
<p>The overhead grows with data size - at 100,000 items, the gap becomes 810x. <strong>This is fundamental to how <code>for await</code> loops work in JavaScript</strong>, not an implementation issue.</p>
<blockquote>
<p><strong>Note</strong>: JavaScript engines continue to optimize async iteration. These performance characteristics may improve in future V8 versions.</p>
</blockquote>
<h2 id="the-v8-optimization-cliff"><a class="header" href="#the-v8-optimization-cliff">The V8 Optimization Cliff</a></h2>
<p><strong>TransformStream performance has a dramatic cliff</strong> - it looks extremely fast in microbenchmarks but can become orders of magnitude slower with minimal added complexity.</p>
<p><strong>Simple operations get heavily optimized:</strong></p>
<pre><code class="language-typescript">// V8 can inline this entire pipeline
const doubleStream = new TransformStream({
  transform(chunk, controller) {
    controller.enqueue(chunk * 2); // Becomes nearly native code
  }
});
// Result: 750x faster than generators
</code></pre>
<p><strong>Adding any complexity breaks optimization:</strong></p>
<pre><code class="language-typescript">// Closure state prevents V8 inlining
function createRunningTotalStream() {
  let total = 0; // This breaks optimization
  return new TransformStream({
    transform(chunk, controller) {
      total += chunk;              // Closure access overhead
      controller.enqueue(total);   // Can't optimize with state
    }
  });
}
// Result: 6x slower than generators
</code></pre>
<p><strong>Why this happens:</strong></p>
<ul>
<li>V8 aggressively optimizes trivial TransformStream operations into native code paths</li>
<li>Any closure variables, state dependencies, or complex logic breaks these optimizations</li>
<li>Once optimization fails, the callback overhead makes TransformStream much slower</li>
<li>Generators have consistent overhead regardless of complexity</li>
</ul>
<p><strong>Practical implication:</strong> TransformStream microbenchmarks are misleading - they show best-case performance that disappears in real-world usage.</p>
<p><strong>The bottom line:</strong> JavaScript performance is notoriously difficult to predict. V8's aggressive optimizations can make simple code incredibly fast, but these optimizations are fragile and break easily. If performance truly matters for your use case, profile your actual workload rather than relying on synthetic benchmarks.</p>
<h2 id="the-chunking-solution"><a class="header" href="#the-chunking-solution">The Chunking Solution</a></h2>
<p>proc uses <strong>chunking</strong> to amortize async iteration costs by processing multiple items per iteration:</p>
<pre><code class="language-typescript">// Instead of: 1 promise per line (expensive)
async function* inefficientLines(bytes: AsyncIterable&lt;Uint8Array&gt;) {
  for await (const chunk of bytes) {
    for (const line of decode(chunk).split('\n')) {
      yield line; // 1000 lines = 1000 promises
    }
  }
}

// proc does: 1 promise per chunk of lines (efficient)
export async function* toChunkedLines(bytes: AsyncIterable&lt;Uint8Array&gt;) {
  for await (const chunk of bytes) {
    const lines = decode(chunk).split('\n');
    if (lines.length &gt; 0) {
      yield lines; // 1000 lines in 10 chunks = 10 promises
    }
  }
}

// Then flatten efficiently
async function* toLines(bytes: AsyncIterable&lt;Uint8Array&gt;) {
  for await (const lines of toChunkedLines(bytes)) {
    yield* lines; // Sync iteration within async iteration
  }
}
</code></pre>
<p><strong>Result</strong>: 10x performance improvement for line processing.</p>
<h2 id="when-complexity-flips-performance"><a class="header" href="#when-complexity-flips-performance">When Complexity Flips Performance</a></h2>
<p>For complex operations, async generators become faster because TransformStream's callback model creates overhead:</p>
<pre><code class="language-typescript">// Complex stateful processing
async function* processLogs(lines: AsyncIterable&lt;string&gt;) {
  let errorCount = 0;
  
  for await (const line of lines) {
    try {
      const entry = JSON.parse(line);
      if (entry.level === 'error') {
        errorCount++;
        yield {
          ...entry,
          errorNumber: errorCount,
          severity: entry.message.includes('critical') ? 'high' : 'medium'
        };
      }
    } catch {
      errorCount++;
    }
  }
}

// Benchmark results (10k items):
// Async generator: 3.1ms
// TransformStream: 13.8ms (4x slower)
</code></pre>
<h2 id="practical-implications"><a class="header" href="#practical-implications">Practical Implications</a></h2>
<p><strong>Async generators win for real-world use cases:</strong></p>
<ul>
<li>Parsing and validation (where most errors occur)</li>
<li>Multi-step transformations</li>
<li>State management across items</li>
<li>Error handling and recovery</li>
</ul>
<p><strong>The chunking strategy makes overhead negligible</strong> for typical data processing workloads.</p>
<p><strong>TransformStream is available</strong> for the rare cases where simple, high-volume transformations need maximum performance, but the complexity trade-off usually isn't worth it.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../advanced/streaming.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../utilities/file-io.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../advanced/streaming.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../utilities/file-io.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../theme/custom.js"></script>



    </div>
    </body>
</html>
